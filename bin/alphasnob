#!/usr/bin/env python3
import subprocess  # nosec B404
import sys
from pathlib import Path

import typer
from rich.console import Console

sys.path.insert(0, str(Path(__file__).parent.parent))

from bot.daemon import DaemonManager
from config.settings import get_settings
from utils.ui import (
    create_config_panel,
    create_status_panel,
    format_uptime,
    print_banner,
    show_error,
    show_info,
    show_success,
    show_warning,
)

app = typer.Typer(help="AlphaSnobAI - Telegram UserBot CLI")
console = Console()


def get_daemon_manager() -> DaemonManager:
    try:
        settings = get_settings()
        return DaemonManager(settings.daemon.pid_file)
    except Exception as e:
        show_error(f"Failed to load settings: {e}")
        raise typer.Exit(1)


@app.command()
def start(
    foreground: bool = typer.Option(
        False,
        "--foreground",
        "-f",
        help="Run in foreground (don't daemonize)",
    ),
    interactive: bool = typer.Option(
        False,
        "--interactive",
        "-i",
        help="Run in interactive mode with live UI",
    ),
):
    print_banner()

    daemon = get_daemon_manager()

    if daemon.is_running():
        pid = daemon.get_pid()
        show_error(f"Bot is already running with PID {pid}")
        show_info("Use 'python bin/alphasnob stop' to stop it first")
        raise typer.Exit(1)

    show_info("Starting AlphaSnob bot...")

    try:
        if interactive:
            show_info("Starting in interactive mode...")
            subprocess.run([sys.executable, "bot/runner.py"], check=True)  # nosec B603
        elif foreground:
            show_info("Running in foreground mode (Ctrl+C to stop)")
            subprocess.run([sys.executable, "main.py"], check=True)  # nosec B603
        else:
            pid = daemon.start()

            if pid > 0:
                show_success("Bot started successfully!")
                show_info(f"PID: {pid}")
                show_info("Status: python cli.py status")
                show_info("Logs: python cli.py logs")
            else:
                import main

                main.main()

    except Exception as e:
        show_error(f"Failed to start bot: {e}")
        raise typer.Exit(1)


@app.command()
def stop(
    force: bool = typer.Option(
        False,
        "--force",
        "-f",
        help="Force kill if graceful shutdown fails",
    ),
):
    daemon = get_daemon_manager()

    if not daemon.is_running():
        show_warning("Bot is not running")
        raise typer.Exit(0)

    pid = daemon.get_pid()
    show_info(f"Stopping bot (PID: {pid})...")

    timeout = 5 if force else 10
    success = daemon.stop(timeout=timeout)

    if success:
        show_success("Bot stopped successfully")
    else:
        show_error("Failed to stop bot")
        if not force:
            show_info("Try using --force flag to force kill")
        raise typer.Exit(1)


@app.command()
def restart():
    daemon = get_daemon_manager()

    show_info("Restarting bot...")

    try:
        pid = daemon.restart(timeout=10)

        if pid > 0:
            show_success("Bot restarted successfully!")
            show_info(f"New PID: {pid}")
        else:
            import main

            main.main()

    except Exception as e:
        show_error(f"Failed to restart bot: {e}")
        raise typer.Exit(1)


@app.command()
def status():
    daemon = get_daemon_manager()
    status_info = daemon.get_status()

    if status_info["running"]:
        uptime_str = format_uptime(int(status_info["uptime"].total_seconds()))

        panel = create_status_panel(
            status="running",
            pid=status_info["pid"],
            uptime=status_info["uptime"],
            messages_processed=0,  # TODO: Get from stats
            responses_sent=0,  # TODO: Get from stats
            last_activity="N/A",  # TODO: Get from stats
        )
        console.print(panel)

        show_info(f"Memory: {status_info['memory_mb']:.1f} MB")
        show_info(f"CPU: {status_info['cpu_percent']:.1f}%")

    else:
        panel = create_status_panel(status="stopped")
        console.print(panel)


@app.command()
def logs(
    follow: bool = typer.Option(False, "--follow", "-f", help="Follow log output"),
    lines: int = typer.Option(50, "--lines", "-n", help="Number of lines to show"),
):
    try:
        settings = get_settings()
        log_file = settings.paths.logs

        if not log_file.exists():
            show_warning(f"Log file not found: {log_file}")
            raise typer.Exit(1)

        if follow:
            show_info(f"Following logs from {log_file} (Ctrl+C to stop)")
            subprocess.run(["tail", "-f", str(log_file)], check=False)  # nosec B603, B607
        else:
            result = subprocess.run(  # nosec B603, B607
                ["tail", "-n", str(lines), str(log_file)],
                check=False,
                capture_output=True,
                text=True,
            )
            console.print(result.stdout)

    except FileNotFoundError:
        show_error("'tail' command not found. Reading file directly...")
        with open(log_file) as f:
            lines_list = f.readlines()
            for line in lines_list[-lines:]:
                console.print(line.rstrip())
    except Exception as e:
        show_error(f"Failed to read logs: {e}")
        raise typer.Exit(1)


@app.command(name="config")
def config_cmd(
    action: str = typer.Argument("show", help="Action: show or validate"),
):
    try:
        settings = get_settings()

        if action == "show":
            config_dict = settings.to_dict()
            panel = create_config_panel(config_dict)
            console.print(panel)

            show_info(f"Config file: {settings.config_path}")
            show_info(f"Secrets file: {settings.secrets_path}")

        elif action == "validate":
            show_info("Validating configuration...")

            warnings = settings.validate()

            if not warnings:
                show_success("Configuration is valid!")
            else:
                show_warning("Configuration has warnings:")
                for warning in warnings:
                    console.print(f"  ⚠️  {warning}")

        else:
            show_error(f"Unknown action: {action}")
            show_info("Available actions: show, validate")
            raise typer.Exit(1)

    except Exception as e:
        show_error(f"Configuration error: {e}")
        raise typer.Exit(1)


@app.command()
def stats(
    chat_id: int | None = typer.Argument(None, help="Chat ID to show stats for"),
):
    # TODO: Implement statistics retrieval from database
    show_warning("Statistics feature coming soon!")
    show_info("Will show:")
    show_info("  - Total messages processed")
    show_info("  - Response rate by chat")
    show_info("  - Most active chats")
    show_info("  - API usage statistics")


@app.command()
def version():
    print_banner()
    console.print("\n[bold cyan]Version:[/bold cyan] 2.0.0")
    console.print("[bold cyan]Python:[/bold cyan] " + sys.version.split()[0])
    console.print("[bold cyan]Mode:[/bold cyan] Daemon + Rich UI + YAML Config")


@app.callback(invoke_without_command=True)
def main_callback(ctx: typer.Context):
    if ctx.invoked_subcommand is None:
        print_banner()
        console.print("\n[bold cyan]Available commands:[/bold cyan]")
        console.print("  [green]start[/green]          - Start the bot")
        console.print("    [dim]--interactive  - Interactive mode with live UI[/dim]")
        console.print("    [dim]--foreground   - Foreground mode (no daemon)[/dim]")
        console.print("  [green]stop[/green]           - Stop the bot daemon")
        console.print("  [green]restart[/green]        - Restart the bot daemon")
        console.print("  [green]status[/green]         - Show bot status")
        console.print("  [green]logs[/green]           - Show bot logs")
        console.print("  [green]config[/green]         - Manage configuration")
        console.print("  [green]version[/green]        - Show version info")
        console.print("\n[dim]Examples:[/dim]")
        console.print("  [cyan]python bin/alphasnob start --interactive[/cyan]")
        console.print("  [cyan]python bin/alphasnob start --foreground[/cyan]")
        console.print("  [cyan]python bin/alphasnob start[/cyan]  [dim](daemon mode)[/dim]\n")


if __name__ == "__main__":
    app()
